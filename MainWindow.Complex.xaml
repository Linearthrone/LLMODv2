<Window x:Class="LLMOverlay.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:LLMOverlay"
    Title="LLM Chat Overlay"
    
    WindowState="Normal"
    ExtendsContentIntoTitleBar="True"
    Background="Transparent"
    
    MinWidth="350"
    MinHeight="500"
    
    Loaded="Window_Loaded"
    PointerPressed="Window_PointerPressed"
    SizeChanged="Window_SizeChanged">
    
    <!-- Windows 11 Background - will be set in code -->
    <!-- <Window.SystemBackdrop>
        <MicaBackdrop Kind="BaseAlt"/>
    </Window.SystemBackdrop> -->

    <Grid x:Name="RootGrid">
        <!-- Main Content Area -->
        <Grid x:Name="MainContentGrid" 
              Visibility="Visible"
              Width="{Binding ActualWidth, ElementName=RootGrid}"
              HorizontalAlignment="Right">
            
            <!-- Background with Glass Effect -->
            <Border x:Name="BackgroundBorder"
                    Background="#E6000000"
                    BorderBrush="#33FFFFFF"
                    BorderThickness="1"
                    CornerRadius="12,0,0,12">
                
                <!-- Main Layout -->
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Header with Model Selection -->
                    <Grid Grid.Row="0" Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- LLM Model Selector -->
                        <ComboBox x:Name="ModelSelector" 
                                  Grid.Column="0"
                                  Header="LLM Model"
                                  PlaceholderText="Select model..."
                                  SelectionChanged="ModelSelector_SelectionChanged"
                                  Margin="0,0,10,0">
                            <ComboBoxItem Content="GPT-3.5 Turbo" Tag="gpt-3.5-turbo"/>
                            <ComboBoxItem Content="GPT-4" Tag="gpt-4"/>
                            <ComboBoxItem Content="Claude-3" Tag="claude-3"/>
                            <ComboBoxItem Content="Local LLM" Tag="local"/>
                        </ComboBox>

                        <!-- Settings Button -->
                        <Button x:Name="SettingsButton"
                                Grid.Column="1"
                                Content="âš™ï¸"
                                ToolTipService.ToolTip="Settings"
                                Width="40"
                                Height="40"
                                Click="SettingsButton_Click"/>

                        <!-- Minimize Button -->
                        <Button x:Name="MinimizeButton"
                                Grid.Column="2"
                                Content="âˆ’"
                                ToolTipService.ToolTip="Minimize to floating button"
                                Width="40"
                                Height="40"
                                Click="MinimizeButton_Click"/>
                    </Grid>

                    <!-- Chat Messages Area -->
                    <ScrollViewer x:Name="MessagesScrollViewer"
                                  Grid.Row="1"
                                  VerticalScrollBarVisibility="Auto"
                                  HorizontalScrollBarVisibility="Disabled"
                                  Margin="0,0,0,10">
                        
                        <ItemsControl x:Name="MessagesContainer">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml">
                                    <Border Margin="5,10,5,5"
                                            Padding="12"
                                            CornerRadius="8"
                                            Background="#333333"
                                            HorizontalAlignment="Left">
                                        
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="Auto"/>
                                                <RowDefinition Height="*"/>
                                                <RowDefinition Height="Auto"/>
                                            </Grid.RowDefinitions>

                                            <!-- Sender -->
                                            <TextBlock Grid.Row="0"
                                                       Text="{Binding Sender}"
                                                       FontWeight="SemiBold"
                                                       FontSize="12"
                                                       Foreground="White"
                                                       Margin="0,0,0,4"/>

                                            <!-- Message Content -->
                                            <TextBlock Grid.Row="1"
                                                       Text="{Binding Content}"
                                                       TextWrapping="Wrap"
                                                       FontSize="14"
                                                       LineHeight="20"
                                                       Foreground="White"
                                                       Margin="0,0,0,4"/>

                                            <!-- Timestamp -->
                                            <TextBlock Grid.Row="2"
                                                       Text="{Binding Timestamp}"
                                                       FontSize="10"
                                                       Foreground="#88FFFFFF"
                                                       HorizontalAlignment="Right"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- Input Area -->
                    <Grid Grid.Row="2">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Attachment and Action Buttons -->
                        <Grid Grid.Row="0" Margin="0,0,0,8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Upload Button -->
                            <Button x:Name="UploadButton"
                                    Grid.Column="0"
                                    Content="ðŸ“Ž"
                                    ToolTipService.ToolTip="Attach file"
                                    Width="40"
                                    Height="40"
                                    Click="UploadButton_Click"/>

                            <!-- Character Count -->
                            <TextBlock x:Name="CharacterCount"
                                       Grid.Column="1"
                                       Text="0/4000"
                                       HorizontalAlignment="Center"
                                       VerticalAlignment="Center"
                                       FontSize="11"
                                       Foreground="#AAFFFFFF"/>

                            <!-- Clear Chat Button -->
                            <Button x:Name="ClearButton"
                                    Grid.Column="2"
                                    Content="ðŸ—‘ï¸"
                                    ToolTipService.ToolTip="Clear chat"
                                    Width="40"
                                    Height="40"
                                    Click="ClearButton_Click"/>
                        </Grid>

                        <!-- Text Input and Send -->
                        <Grid Grid.Row="1">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Input TextBox -->
                            <TextBox x:Name="MessageInput"
                                     Grid.Column="0"
                                     PlaceholderText="Type your message..."
                                     AcceptsReturn="True"
                                     TextWrapping="Wrap"
                                     MaxLength="4000"
                                     Height="80"
                                     VerticalAlignment="Stretch"
                                     TextChanged="MessageInput_TextChanged"
                                     KeyDown="MessageInput_KeyDown"/>

                            <!-- Send Button -->
                            <Button x:Name="SendButton"
                                    Grid.Column="1"
                                    Content="âž¤"
                                    Width="50"
                                    Height="50"
                                    Margin="8,0,0,0"
                                    Click="SendButton_Click"/>
                        </Grid>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <!-- Floating Button (Minimized State) -->
        <Button x:Name="FloatingButton"
                Visibility="Collapsed"
                Content="ðŸ’¬"
                Width="60"
                Height="60"
                HorizontalAlignment="Right"
                VerticalAlignment="Center"
                Background="#E6000000"
                Foreground="White"
                BorderBrush="#33FFFFFF"
                BorderThickness="1"
                CornerRadius="30"
                FontSize="24"
                Click="FloatingButton_Click"
                PointerEntered="FloatingButton_PointerEntered"
                PointerExited="FloatingButton_PointerExited">
            <Button.Flyout>
                <Flyout>
                    <TextBlock Text="Click to expand chat" 
                               FontSize="12"
                               Margin="10"/>
                </Flyout>
            </Button.Flyout>
        </Button>

        <!-- Loading Overlay -->
        <Grid x:Name="LoadingOverlay"
              Visibility="Collapsed"
              Background="#AA000000">
            <StackPanel HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                <ProgressRing IsActive="True"
                              Width="50"
                              Height="50"
                              Foreground="White"
                              Margin="0,0,0,10"/>
                <TextBlock Text="Loading..."
                           FontSize="14"
                           Foreground="White"
                           HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>